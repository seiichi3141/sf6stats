# 要件定義書

## 背景と目的

- ストリートファイター6のキャラクター使用率・勝率・対戦ダイヤグラムを可視化し、プレイヤー/コミュニティがメタを把握できるサイトを提供する。
- 公式 API (月次) から統計を取得し、全体とマスター帯の差異を示す。

## データソース

- 使用率 (全体): <https://www.streetfighter.com/6/buckler/api/ja-jp/stats/usagerate/202509>
- 対戦ダイヤ (全体): <https://www.streetfighter.com/6/buckler/api/ja-jp/stats/dia/202509>
- 使用率 (マスター): <https://www.streetfighter.com/6/buckler/api/ja-jp/stats/usagerate_master/202509>
- 対戦ダイヤ (マスター): <https://www.streetfighter.com/6/buckler/api/ja-jp/stats/dia_master/202509>
- 想定フォーマット: JSON。期間指定は URL の年月パス (例: `202509`) で切替。
- サンプル保存: `data/sample/*.json` に 202509 の抜粋を保存済み。型定義は `types/stats.ts`。
- 使用率スキーマ: `usagerateData[].val[]` 配下に `league_rank`/`league_alpha` ごとの `val` (キャラ配列)。キャラ要素は `character_tool_name`, `play_rate`, `previous_rate`, `count`, `play_cnt`, `total_cnt`。
- ダイヤスキーマ: `diaData.ci.ci_sort` (全体) / `diaData.c.ci_sort` (マスター) 下にリーグキー→`opponent_header` と `records`。`records[].values[]` に `_dsort`(0〜1前後の勝率相当値) と `val` (表示用数値文字列)。

## 対象ユーザー

- ランク帯別のメタを把握したいプレイヤー。
- 対戦会/大会運営者（バランス把握）。
- コーチ/コンテンツ制作者（解説資料作成）。

## 機能要件

1) キャラクターメタ概要
   - 使用率トップ/ボトムのランキング表示（全体・マスター切替）。`play_rate` と `previous_rate` の差分を矢印/色で表示。
   - 使用率と `_dsort` 平均（ダイヤの勝率相当値）を併記し、メタ人気とパフォーマンスのズレを可視化。
   - 期間セレクタ (年月) でデータを切替。
2) 対戦ダイヤグラム
   - キャラ×キャラの相性表をヒートマップ表示（全体 `ci_sort` / マスター `c.ci_sort` 切替）。
   - 特定キャラの `records[].values` を用い、有利/不利マッチアップ上位 N 件をソート表示。
   - `_dsort` しきい値: 有利 >0.55、五分 0.45〜0.55、不利 <0.45 を凡例表示。`val` (表示用数値文字列) もセルに併記。
3) キャラ詳細ビュー
   - 使用率 (全体/マスター) と前月比 (`previous_rate`) のカード表示。
   - マッチアップ一覧 (`records.values`) を有利/不利フィルタ、`sf`/`thm` などフラグ付きで表示。
   - マスター帯と全体の `_dsort` 差分を棒グラフで比較。
4) エクスポート/共有
   - 表やリストの CSV/画像エクスポート。
   - 共有用の URL パラメータ（期間、キャラ、モード）。
5) 更新情報
   - データ最終更新日時と取得元 URL を表示。

## 非機能要件

- パフォーマンス: 初回ロード < 2s (キャッシュ利用、SSR/ISR を検討)。
- 可用性: API 失敗時はリトライとフォールバック (直近キャッシュ) を表示。
- 表示対応: PC/モバイル両対応、ヒートマップは横スクロールまたは縮小ビューを用意。
- アクセシビリティ: 色分けに加え数値/ラベルを併記。

## データ取得・更新

- 月次で API パスが変わるため、最新年月を自動判定する仕組みを用意（例: 当月をデフォルト、過去月は選択式）。
- 取得した JSON をサーバー側でキャッシュし、一定期間で再取得 (例: 6時間)。
- キャッシュ失敗時は前回成功分を提示し、エラーメッセージを表示。

## 技術的方針

- Next.js App Router。サーバーコンポーネントでデータ取得し、クライアントは表示・インタラクションのみ。
- 型定義を用意し、API スキーマを明示 (UsageRate, DiaMatrix など)。
- Tailwind 4 でレイアウト・ヒートマップのカラースケールを定義。

## 今後の拡張余地

- シーズン/パッチごとの差分表示。
- 大会リザルトや CFN のユーザーデータと組み合わせた分析。
- コメント/フィードバック投稿機能。
